<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ChronomÃ¨tre ECOS</title>

  <style>
    :root{
      --primary:#007bff;
      --primary-dark:#0056c7;
      --bg:#f0f0f0;
      --card:#ffffff;

      /* Couleurs de la pause */
      --pause-bg:#fdf3e6;
      --pause-card:#ffe1c2;
    }

    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      font-family:Arial,Helvetica,sans-serif;
    }

    body.pause-mode{
      background:var(--pause-bg);
    }
    body.pause-mode .card{
      background:var(--pause-card);
    }

    .wrap{
      min-height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:1rem;
    }

    .card{
      background:var(--card);
      border-radius:12px;
      box-shadow:0 6px 18px rgba(0,0,0,0.08);
      padding:1.5rem;
      max-width:720px;
      width:100%;
      text-align:center;
    }

    h1{
      margin:0 0 0.5rem 0;
      font-size:clamp(1.25rem,3.5vw,2rem);
    }

    #timer{
      font-size:clamp(3rem,9vw,6rem);
      margin:0.25rem 0 0.75rem 0;
    }

    #phase{
      font-size:clamp(1rem,2.6vw,1.25rem);
      color:#333;
      margin-bottom:0.5rem;
    }

    #cycles,#sessionNumber{
      font-size:clamp(0.9rem,2.2vw,1rem);
      color:#444;
      margin:0.25rem 0;
    }

    .controls{
      display:flex;
      gap:0.5rem;
      flex-wrap:wrap;
      justify-content:center;
      margin-top:1rem;
    }

    .controls-main{
      margin-top:1.5rem;
    }

    .controls-secondary{
      margin-top:2rem;
      border-top:1px solid #ddd;
      padding-top:1rem;
    }

    button{
      padding:0.9rem 1.2rem;
      border-radius:10px;
      border:0;
      background:var(--primary);
      color:#fff;
      font-size:clamp(0.9rem,2.2vw,1rem);
      cursor:pointer;
      width:160px;
      max-width:45vw;
    }

    button:active{
      transform:scale(0.98);
      background:var(--primary-dark);
    }

    .secondary{
      background:#6c757d;
    }

    footer{
      margin-top:1rem;
      font-size:0.85rem;
      color:#666;
      word-break:break-all;
    }

    @media (max-width:420px){
      button{width:100%}
      .card{padding:1rem}
    }

    /* MODE PROJECTEUR / PLEIN Ã‰CRAN */
    .fullscreen-active .controls-main button:not(#fullscreen),
    .fullscreen-active .controls-secondary {
      display: none !important;
    }

    #fullscreen.fullscreen-button-small{
      position:fixed;
      bottom:10px;
      left:50%;
      transform:translateX(-50%);
      font-size:0.8rem;
      padding:0.4rem 0.8rem;
      width:auto;
      opacity:0.5;
      z-index:9999;
    }

    #fullscreen.fullscreen-button-small:hover{
      opacity:1;
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>ChronomÃ¨tre ECOS</h1>

    <div id="phase">PrÃªt</div>
    <div id="timer">08:00</div>
    <div id="cycles">Cycle : 0 / 5</div>
    <div id="sessionNumber">Station : -</div>

    <div class="controls controls-main">
      <button id="start">DÃ©marrer</button>
      <button id="fullscreen" class="secondary">Plein Ã©cran</button>
    </div>

    <div class="controls controls-secondary">
      <button id="pause" class="secondary">Pause</button>
      <button id="reset" class="secondary">RÃ©initialiser</button>
    </div>

    <audio id="beep" preload="auto">
      <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
    </audio>

    <footer>
      Session ID : <span id="sessionIdSpan">default</span>
    </footer>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
/* CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyAb0JrnpRAXYM6op6W7bmCwhBxScyOHYyM",
  authDomain: "ecos-blancs.firebaseapp.com",
  projectId: "ecos-blancs",
  storageBucket: "ecos-blancs.firebasestorage.app",
  messagingSenderId: "88962953870",
  appId: "1:88962953870:web:c37b8c705c89ed68bd8fdf"
};

const WORK_DURATION = 8 * 60;
const BREAK_DURATION = 2 * 60;
const TOTAL_WORK_CYCLES = 5;

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

function getSessionId(){
  const p = new URLSearchParams(window.location.search);
  return p.get("sid") || p.get("session") || "default";
}

const sessionId = getSessionId();
document.getElementById("sessionIdSpan").textContent = sessionId;

const docRef = db.collection("sessions").doc(sessionId);

/* Elements */
const phaseEl = document.getElementById("phase");
const timerEl = document.getElementById("timer");
const cyclesEl = document.getElementById("cycles");
const sessionNumberEl = document.getElementById("sessionNumber");
const startBtn = document.getElementById("start");
const pauseBtn = document.getElementById("pause");
const resetBtn = document.getElementById("reset");
const fullscreenBtn = document.getElementById("fullscreen");
const beep = document.getElementById("beep");

/* State */
let remoteState = null;
let lastPhaseName = null;
let tickTimer = null;
let isProjectorMode = false;

/* Tools */
const fmt = sec => {
  if(sec<0) sec=0;
  return String(Math.floor(sec/60)).padStart(2,"0")+":"+
         String(sec%60).padStart(2,"0");
};

function computeTimeLeft(s){
  if(!s || !s.isStarted) return WORK_DURATION;
  if(s.isPaused) return s.pausedRemaining ?? WORK_DURATION;

  const dur = s.phaseDuration || (s.phase==="work"?WORK_DURATION:BREAK_DURATION);
  if(!s.phaseStart) return dur;

  const elapsed = (Date.now() - s.phaseStart.toDate().getTime())/1000;
  return Math.floor(dur - elapsed);
}

function updateUI(){
  /* pause color */
  if(remoteState?.phase === "break" && remoteState.isStarted && !remoteState.finished){
    document.body.classList.add("pause-mode");
  } else {
    document.body.classList.remove("pause-mode");
  }

  if(!remoteState){
    phaseEl.textContent = "PrÃªt";
    timerEl.textContent = fmt(WORK_DURATION);
    cyclesEl.textContent = "Cycle : 0 / 5";
    sessionNumberEl.textContent = "Station : -";
    return;
  }

  /* Not started yet */
  if(!remoteState.isStarted){
    phaseEl.textContent = "PrÃªt";
    timerEl.textContent = "08:00";
    cyclesEl.textContent = "Cycle : 0 / 5";
    sessionNumberEl.textContent = "Station : -";
    pauseBtn.textContent = "Pause";
    return;
  }

  /* Running */
  const tl = computeTimeLeft(remoteState);

  if(remoteState.finished){
    phaseEl.textContent = "TerminÃ© ! ðŸŽ‰";
    timerEl.textContent = "00:00";
  } else {
    phaseEl.textContent =
      (remoteState.phase==="work"
        ?"Travail (8 min)"
        :"Pause (2 min)")
      + (remoteState.isPaused?" (en pause)":"");
    timerEl.textContent = fmt(tl);
  }

  cyclesEl.textContent = `Cycle : ${remoteState.cyclesDone || 0} / 5`;

  if(remoteState.phase==="work"){
    sessionNumberEl.textContent =
      `Station : ${remoteState.workSessionNumber||1} / 5`;
  } else if(remoteState.phase==="break"){
    sessionNumberEl.textContent =
      `Pause : ${remoteState.breakSessionNumber||1} / 4`;
  } else {
    sessionNumberEl.textContent="Station : -";
  }

  pauseBtn.textContent = remoteState.isPaused ? "Reprendre" : "Pause";
}

function maybeBeep(phase){
  if(lastPhaseName!==null && lastPhaseName!==phase){
    beep.currentTime=0;
    beep.play().catch(()=>{});
  }
  lastPhaseName=phase;
}

function startLocalTicker(){
  if(tickTimer) return;
  tickTimer = setInterval(()=>{
    if(!remoteState) return;
    updateUI();
    if(remoteState.isStarted && !remoteState.isPaused && !remoteState.finished){
      const tl = computeTimeLeft(remoteState);
      if(tl<=0) advancePhase();
    }
  },1000);
}

/* Phase transitions */
async function advancePhase(){
  await db.runTransaction(async tx=>{
    const snap = await tx.get(docRef);
    if(!snap.exists) return;
    const s = snap.data();

    if(!s.isStarted || s.isPaused || s.finished) return;

    const dur = s.phaseDuration || (s.phase==="work"?WORK_DURATION:BREAK_DURATION);
    const elapsed = (firebase.firestore.Timestamp.now().seconds - s.phaseStart.seconds);

    if(elapsed < dur) return;

    const next = {...s};

    if(s.phase==="work"){
      next.cyclesDone = (s.cyclesDone||0)+1;
      next.workSessionNumber = (s.workSessionNumber||1)+1;

      if(next.cyclesDone>=5){
        next.phase="finished";
        next.finished=true;
      } else {
        next.phase="break";
        next.phaseDuration=BREAK_DURATION;
      }
    } else if(s.phase==="break"){
      next.breakSessionNumber = (s.breakSessionNumber||1)+1;
      next.phase="work";
      next.phaseDuration=WORK_DURATION;
    }

    next.phaseStart = firebase.firestore.FieldValue.serverTimestamp();
    next.isPaused = false;
    next.pausedRemaining = null;

    tx.set(docRef,next,{merge:true});
  });
}

/* Snapshot */
docRef.onSnapshot(snap=>{
  if(!snap.exists){
    remoteState=null;
    updateUI();
    return;
  }
  remoteState = snap.data();
  maybeBeep(remoteState.phase);
  updateUI();
  startLocalTicker();
});

/* BUTTONS */

/* START */
startBtn.addEventListener("click",async()=>{
  if(!confirm("DÃ©marrer le chronomÃ¨tre ?")) return;

  await db.runTransaction(async tx=>{
    const snap=await tx.get(docRef);

    if(!snap.exists){
      tx.set(docRef,{
        isStarted:true,
        phase:"work",
        phaseDuration:WORK_DURATION,
        phaseStart:firebase.firestore.FieldValue.serverTimestamp(),
        cyclesDone:0,
        workSessionNumber:1,
        breakSessionNumber:1,
        finished:false,
        isPaused:false,
        pausedRemaining:null
      });
    } else {
      const s=snap.data();
      tx.set(docRef,{
        isStarted:true,
        isPaused:false,
        pausedRemaining:null,
        finished:false,
        phase:s.phase || "work",
        phaseDuration:(s.phase==="work"?WORK_DURATION:BREAK_DURATION),
        phaseStart:firebase.firestore.FieldValue.serverTimestamp()
      },{merge:true});
    }
  });
});

/* PAUSE */
pauseBtn.addEventListener("click",async()=>{
  if(!remoteState?.isStarted) return;

  const action = remoteState.isPaused ? "reprendre" : "mettre en pause";
  if(!confirm("Voulez-vous vraiment "+action+" ?")) return;

  await db.runTransaction(async tx=>{
    const snap=await tx.get(docRef);
    if(!snap.exists) return;
    const s=snap.data();
    if(!s.isStarted || s.finished) return;

    if(s.isPaused){
      tx.update(docRef,{
        isPaused:false,
        pausedRemaining:null,
        phaseStart:firebase.firestore.FieldValue.serverTimestamp()
      });
    } else {
      const tl = computeTimeLeft(s);
      tx.update(docRef,{
        isPaused:true,
        pausedRemaining:tl
      });
    }
  });
});

/* RESET â€” n'active plus isStarted */
resetBtn.addEventListener("click",async()=>{
  if(!confirm("RÃ©initialiser complÃ¨tement ?")) return;

  await docRef.set({
    isStarted:false,
    phase:"work",
    phaseDuration:WORK_DURATION,
    phaseStart:null,
    cyclesDone:0,
    workSessionNumber:1,
    breakSessionNumber:1,
    finished:false,
    isPaused:false,
    pausedRemaining:null
  });
});

/* FULLSCREEN / MODE PROJECTEUR */
function applyProjectorMode(){
  if(isProjectorMode){
    fullscreenBtn.textContent="Quitter le plein Ã©cran";
    fullscreenBtn.classList.add("fullscreen-button-small");
    document.body.classList.add("fullscreen-active");
  } else {
    fullscreenBtn.textContent="Plein Ã©cran";
    fullscreenBtn.classList.remove("fullscreen-button-small");
    document.body.classList.remove("fullscreen-active");
  }
}

fullscreenBtn.addEventListener("click",()=>{
  isProjectorMode=!isProjectorMode;
  applyProjectorMode();

  // tente vrai fullscreen si possible
  if(isProjectorMode){
    if(document.documentElement.requestFullscreen){
      document.documentElement.requestFullscreen().catch(()=>{});
    }
  } else {
    if(document.exitFullscreen){
      document.exitFullscreen().catch(()=>{});
    }
  }
});
</script>

</body>
</html>
