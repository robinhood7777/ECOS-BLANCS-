<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chronom√®tre ECOS</title>

  <style>
    :root{
      --primary:#007bff;
      --primary-dark:#0056c7;
      --bg:#f0f0f0;
      --card:#ffffff;
    }
    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      font-family:Arial,Helvetica,sans-serif;
    }
    .wrap{
      min-height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:1rem;
    }
    .card{
      background:var(--card);
      border-radius:12px;
      box-shadow:0 6px 18px rgba(0,0,0,0.08);
      padding:1.5rem;
      max-width:720px;
      width:100%;
      text-align:center;
    }
    h1{
      margin:0 0 0.5rem 0;
      font-size:clamp(1.25rem,3.5vw,2rem);
    }
    #timer{
      font-size:clamp(3rem,9vw,6rem);
      margin:0.25rem 0 0.75rem 0;
    }
    #phase{
      font-size:clamp(1rem,2.6vw,1.25rem);
      color:#333;
      margin-bottom:0.5rem;
    }
    #cycles,#sessionNumber{
      font-size:clamp(0.9rem,2.2vw,1rem);
      color:#444;
      margin:0.25rem 0;
    }
    .controls{
      display:flex;
      gap:0.5rem;
      flex-wrap:wrap;
      justify-content:center;
      margin-top:1rem;
    }
    button{
      padding:0.9rem 1.2rem;
      border-radius:10px;
      border:0;
      background:var(--primary);
      color:#fff;
      font-size:clamp(0.9rem,2.2vw,1rem);
      cursor:pointer;
      width:140px;
      max-width:40vw;
    }
    button:active{
      transform:scale(0.98);
      background:var(--primary-dark);
    }
    .secondary{
      background:#6c757d;
    }
    footer{
      margin-top:1rem;
      font-size:0.85rem;
      color:#666;
      word-break:break-all;
    }
    @media (max-width:420px){
      button{width:100%}
      .card{padding:1rem}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Chronom√®tre ECOS</h1>

      <div id="phase">Pr√™t</div>
      <div id="timer">08:00</div>
      <div id="cycles">Cycle : 0 / 5</div>
      <div id="sessionNumber">Session : -</div>

      <div class="controls">
        <button id="start">D√©marrer</button>
        <button id="pause" class="secondary">Pause</button>
        <button id="reset" class="secondary">R√©initialiser</button>
      </div>

      <audio id="beep" preload="auto">
        <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
      </audio>

      <footer>
        Session ID : <span id="sessionIdSpan">default</span>
      </footer>
    </div>
  </div>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // --- CONFIG FIREBASE (ta config) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAb0JrnpRAXYM6op6W7bmCwhBxScyOHYyM",
      authDomain: "ecos-blancs.firebaseapp.com",
      projectId: "ecos-blancs",
      storageBucket: "ecos-blancs.firebasestorage.app",
      messagingSenderId: "88962953870",
      appId: "1:88962953870:web:c37b8c705c89ed68bd8fdf"
    };

    // Dur√©es (en secondes)
    const WORK_DURATION = 8 * 60;
    const BREAK_DURATION = 2 * 60;
    const TOTAL_WORK_CYCLES = 5;

    // --- Init Firebase / Firestore ---
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function getSessionId() {
      const p = new URLSearchParams(window.location.search);
      return p.get("sid") || p.get("session") || "default";
    }

    const sessionId = getSessionId();
    document.getElementById("sessionIdSpan").textContent = sessionId;
    const docRef = db.collection("sessions").doc(sessionId);

    // DOM
    const phaseEl = document.getElementById("phase");
    const timerEl = document.getElementById("timer");
    const cyclesEl = document.getElementById("cycles");
    const sessionNumberEl = document.getElementById("sessionNumber");
    const startBtn = document.getElementById("start");
    const pauseBtn = document.getElementById("pause");
    const resetBtn = document.getElementById("reset");
    const beep = document.getElementById("beep");

    // √âtat local
    let remoteState = null;
    let lastPhaseName = null;
    let tickTimer = null;

    function formatTime(seconds) {
      if (seconds < 0) seconds = 0;
      const m = String(Math.floor(seconds / 60)).padStart(2, "0");
      const s = String(Math.floor(seconds % 60)).padStart(2, "0");
      return m + ":" + s;
    }

    function computeTimeLeft(state) {
      if (!state) return WORK_DURATION;

      // Si en pause, utiliser le temps fig√©
      if (state.isPaused && typeof state.pausedRemaining === "number") {
        return state.pausedRemaining;
      }

      const phaseDuration =
        state.phaseDuration ||
        (state.phase === "work" ? WORK_DURATION : BREAK_DURATION);

      if (!state.phaseStart) return phaseDuration;

      const startMs = state.phaseStart.toDate().getTime();
      const nowMs = Date.now();
      const elapsed = Math.floor((nowMs - startMs) / 1000);
      return phaseDuration - elapsed;
    }

    function updateUI() {
      if (!remoteState) {
        phaseEl.textContent = "Pr√™t";
        timerEl.textContent = formatTime(WORK_DURATION);
        cyclesEl.textContent = `Cycle : 0 / ${TOTAL_WORK_CYCLES}`;
        sessionNumberEl.textContent = "Session : -";
        pauseBtn.textContent = "Pause";
        return;
      }

      const isWork = remoteState.phase === "work";
      const timeLeft = computeTimeLeft(remoteState);

      if (remoteState.finished) {
        phaseEl.textContent = "Termin√© ! üéâ";
        timerEl.textContent = "00:00";
      } else {
        phaseEl.textContent = isWork ? "Travail (8 min)" : "Pause (2 min)";
        if (remoteState.isPaused) {
          phaseEl.textContent += " (en pause)";
        }
        timerEl.textContent = formatTime(timeLeft);
      }

      cyclesEl.textContent =
        `Cycle : ${remoteState.cyclesDone || 0} / ${TOTAL_WORK_CYCLES}`;

      if (remoteState.phase === "work") {
        sessionNumberEl.textContent =
          `Session de travail : ${remoteState.workSessionNumber || 1} / ${TOTAL_WORK_CYCLES}`;
      } else if (remoteState.phase === "break") {
        sessionNumberEl.textContent =
          `Session de pause : ${remoteState.breakSessionNumber || 1} / ${TOTAL_WORK_CYCLES - 1}`;
      } else {
        sessionNumberEl.textContent = "Session : -";
      }

      pauseBtn.textContent = remoteState.isPaused ? "Reprendre" : "Pause";
    }

    function maybePlayBeep(phaseName) {
      if (lastPhaseName !== null && phaseName !== lastPhaseName) {
        beep.currentTime = 0;
        beep.play().catch(() => {});
      }
      lastPhaseName = phaseName;
    }

    async function tryAdvancePhase() {
      try {
        await db.runTransaction(async (tx) => {
          const d = await tx.get(docRef);
          if (!d.exists) return;
          const data = d.data();

          if (data.finished || data.isPaused) return;
          if (!data.phaseStart) return;

          const now = firebase.firestore.Timestamp.now();
          const phaseDuration =
            data.phaseDuration ||
            (data.phase === "work" ? WORK_DURATION : BREAK_DURATION);
          const elapsed = now.seconds - data.phaseStart.seconds;
          if (elapsed < phaseDuration) return;

          let next = { ...data };

          if (data.phase === "work") {
            next.cyclesDone = (data.cyclesDone || 0) + 1;
            next.workSessionNumber = (data.workSessionNumber || 1) + 1;

            if (next.cyclesDone >= TOTAL_WORK_CYCLES) {
              next.phase = "finished";
              next.finished = true;
              next.phaseDuration = 0;
              next.phaseStart =
                firebase.firestore.FieldValue.serverTimestamp();
              next.isPaused = false;
              next.pausedRemaining = null;
              tx.set(docRef, next, { merge: true });
              return;
            } else {
              next.phase = "break";
              next.phaseDuration = BREAK_DURATION;
              next.phaseStart =
                firebase.firestore.FieldValue.serverTimestamp();
              next.isPaused = false;
              next.pausedRemaining = null;
              tx.set(docRef, next, { merge: true });
              return;
            }
          } else if (data.phase === "break") {
            next.breakSessionNumber = (data.breakSessionNumber || 1) + 1;
            next.phase = "work";
            next.phaseDuration = WORK_DURATION;
            next.phaseStart =
              firebase.firestore.FieldValue.serverTimestamp();
            next.isPaused = false;
            next.pausedRemaining = null;
            tx.set(docRef, next, { merge: true });
            return;
          }
        });
      } catch (e) {
        console.error("transaction error", e);
      }
    }

    function startLocalTicker() {
      if (tickTimer) return;
      tickTimer = setInterval(() => {
        if (!remoteState) return;
        updateUI();
        if (!remoteState.finished && !remoteState.isPaused) {
          const tl = computeTimeLeft(remoteState);
          if (tl <= 0) {
            tryAdvancePhase();
          }
        }
      }, 1000);
    }

    // √âcoute Firestore
    docRef.onSnapshot(
      (snap) => {
        if (!snap.exists) {
          remoteState = null;
          updateUI();
          return;
        }
        remoteState = snap.data();
        maybePlayBeep(remoteState.phase);
        updateUI();
        if (remoteState) {
          startLocalTicker();
        }
      },
      (err) => {
        console.error("snapshot error", err);
      }
    );

    // Bouton D√©marrer
    startBtn.addEventListener("click", async () => {
      try {
        await db.runTransaction(async (tx) => {
          const d = await tx.get(docRef);
          if (!d.exists) {
            tx.set(docRef, {
              phase: "work",
              phaseDuration: WORK_DURATION,
              phaseStart:
                firebase.firestore.FieldValue.serverTimestamp(),
              cyclesDone: 0,
              workSessionNumber: 1,
              breakSessionNumber: 1,
              totalWorkCycles: TOTAL_WORK_CYCLES,
              finished: false,
              isPaused: false,
              pausedRemaining: null
            });
          } else {
            const data = d.data();
            if (data.finished) {
              tx.set(
                docRef,
                {
                  phase: "work",
                  phaseDuration: WORK_DURATION,
                  phaseStart:
                    firebase.firestore.FieldValue.serverTimestamp(),
                  cyclesDone: 0,
                  workSessionNumber: 1,
                  breakSessionNumber: 1,
                  totalWorkCycles: TOTAL_WORK_CYCLES,
                  finished: false,
                  isPaused: false,
                  pausedRemaining: null
                },
                { merge: true }
              );
            } else if (data.isPaused) {
              const remaining =
                typeof data.pausedRemaining === "number"
                  ? data.pausedRemaining
                  : (data.phaseDuration ||
                    (data.phase === "work"
                      ? WORK_DURATION
                      : BREAK_DURATION));
              tx.update(docRef, {
                isPaused: false,
                pausedRemaining: null,
                phaseDuration: remaining,
                phaseStart:
                  firebase.firestore.FieldValue.serverTimestamp()
              });
            } else {
              const newDur =
                data.phase === "work" ? WORK_DURATION : BREAK_DURATION;
              tx.update(docRef, {
                phaseDuration: newDur,
                phaseStart:
                  firebase.firestore.FieldValue.serverTimestamp(),
                isPaused: false,
                finished: false
              });
            }
          }
        });
      } catch (e) {
        console.error("start error", e);
      }
    });

    // Bouton Pause (pause/reprise globale)
    pauseBtn.addEventListener("click", async () => {
      try {
        await db.runTransaction(async (tx) => {
          const d = await tx.get(docRef);
          if (!d.exists) return;
          const data = d.data();
          if (data.finished) return;

          if (data.isPaused) {
            const remaining =
              typeof data.pausedRemaining === "number"
                ? data.pausedRemaining
                : (data.phaseDuration ||
                  (data.phase === "work"
                    ? WORK_DURATION
                    : BREAK_DURATION));
            tx.update(docRef, {
              isPaused: false,
              pausedRemaining: null,
              phaseDuration: remaining,
              phaseStart:
                firebase.firestore.FieldValue.serverTimestamp()
            });
          } else {
            const now = firebase.firestore.Timestamp.now();
            const phaseDuration =
              data.phaseDuration ||
              (data.phase === "work" ? WORK_DURATION : BREAK_DURATION);
            let elapsed = 0;
            if (data.phaseStart) {
              elapsed = now.seconds - data.phaseStart.seconds;
            }
            let remaining = phaseDuration - elapsed;
            if (remaining < 0) remaining = 0;

            tx.update(docRef, {
              isPaused: true,
              pausedRemaining: remaining
            });
          }
        });
      } catch (e) {
        console.error("pause error", e);
      }
    });

    // Bouton Reset
    resetBtn.addEventListener("click", async () => {
      try {
        await docRef.set({
          phase: "work",
          phaseDuration: WORK_DURATION,
          phaseStart:
            firebase.firestore.FieldValue.serverTimestamp(),
          cyclesDone: 0,
          workSessionNumber: 1,
          breakSessionNumber: 1,
          totalWorkCycles: TOTAL_WORK_CYCLES,
          finished: false,
          isPaused: false,
          pausedRemaining: null
        });
      } catch (e) {
        console.error("reset error", e);
      }
    });

    console.log("Chronom√®tre ECOS initialis√©. Session :", sessionId);
    console.log("Ouvre la m√™me URL (avec le m√™me ?sid=‚Ä¶) sur d'autres appareils pour synchroniser.");
  </script>
</body>
</html>
